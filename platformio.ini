; PlatformIO Project Configuration File

; IMPORTANT: Please read ./lib/Architecture.md file BEFORE making changes to this file, as
; it contains information about the project structure and test environment.

[env]
lib_deps = 
	https://github.com/hideakitai/ArduinoEigen
extra_scripts = 
    pre:scripts/pre_build.py
    ; pre:scripts/generate_scenes.py
    ; pre:scripts/generate_points.py
platform_packages =
    platformio/tool-scons
build_flags = 
	-DCORE_DEBUG_LEVEL=0
	-Wno-class-memaccess      ; For STL container warnings
	-Wno-unused-variable      ; For registration static bools
	-Wno-reorder             ; For class member initialization order
	-Wno-deprecated-register  ; Silence FastLED warnings
monitor_filters = direct

[env:teensy41]  # Regular firmware build
platform = teensy
board = teensy41
framework = arduino
board_build.f_cpu = 600000000L
lib_deps = 
    ${env.lib_deps}
    fastled/FastLED @ ~3.9.12
    https://github.com/LAtimes2/InternalTemperature
    https://github.com/adafruit/Adafruit_LSM6DS
build_flags = 
    -D TEENSY_OPT_FASTEST
    -D PLATFORM_TEENSY
    -Wno-psabi
    -Wno-deprecated-register

[env:teensy41_test]  # Hardware test environment
platform = teensy
board = teensy41
framework = arduino
board_build.f_cpu = 600000000L
test_framework = doctest
test_speed = 115200
lib_deps = 
    ${env.lib_deps}
    fastled/FastLED @ ~3.9.12
    doctest/doctest@^2.4.11
build_flags = 
    -D PLATFORM_TEENSY
    -D DOCTEST_CONFIG_NO_EXCEPTIONS_BUT_WITH_ALL_ASSERTS
    -D DOCTEST_CONFIG_NO_MULTITHREADING
    -I".pio/libdeps/teensy41_test/ArduinoEigen/ArduinoEigen"    
    -fexceptions
    -fno-exceptions            # Disable C++ exceptions
    -fno-non-call-exceptions   # Disable non-call exceptions
    -Wno-psabi 
    -std=gnu++17  # Enable C++17 features
test_filter = test_hardware
test_ignore = test_native

[env:native]  # Native test environment
platform = native
test_framework = doctest
lib_ldf_mode = chain+
lib_deps =
    ${env.lib_deps}
    doctest/doctest@^2.4.11
build_flags = 
    -I"test/fixtures"
    -I"test/helpers"
    -I"lib/PixelTheater/include"    
    -I"src/models"          # user-defined stage models for use in hardware
    -I"test/test_native"    # test stage models in test/test_native/fixtures/models
    -I".pio/libdeps/native/doctest/doctest"
    -I".pio/libdeps/native/ArduinoEigen/ArduinoEigen"
    -DUNIT_TEST
    -DTEST_BUILD
    -DMOCK_HARDWARE
    -DPLATFORM_NATIVE
    -std=gnu++17  # Match native environment
test_filter = 
    test_native
test_ignore = 
    test_hardware
    